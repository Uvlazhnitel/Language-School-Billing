# Language School Billing - Project Map

## Overview
Single-user desktop application for managing language school billing, built with Go (backend) and React/TypeScript (frontend) using Wails v2 framework.

**Stack**: Go 1.22+, Wails v2, ent ORM, SQLite, gofpdf, React, TypeScript, Vite

## Project Structure

```
Language-School-Billing/
├── main.go                     # Application entry point (Wails initialization)
├── app.go                      # Main application controller (bindings, services)
├── crud.go                     # CRUD operations for Students, Courses, Enrollments
├── go.mod/go.sum              # Go dependencies
├── wails.json                 # Wails configuration
│
├── ent/                       # Database schema & generated ORM code (ent)
│   ├── schema/                # Entity definitions
│   │   ├── student.go
│   │   ├── course.go
│   │   ├── enrollment.go
│   │   ├── invoice.go
│   │   ├── payment.go
│   │   └── attendancemonth.go
│   └── [generated files]      # Auto-generated by ent
│
├── internal/                  # Internal Go packages
│   ├── app/                   # Business logic services
│   │   ├── constants.go       # Shared constants (billing modes, statuses, etc.)
│   │   ├── attendance/
│   │   │   └── service.go     # Attendance tracking logic
│   │   ├── invoice/
│   │   │   └── service.go     # Invoice generation & PDF creation
│   │   └── payment/
│   │       └── service.go     # Payment tracking & balance calculations
│   ├── infra/
│   │   └── db.go             # Database initialization
│   ├── paths/
│   │   └── paths.go          # Application directory management
│   └── pdf/
│       └── invoice_pdf.go    # PDF generation logic
│
└── frontend/                  # React/TypeScript UI (Wails frontend)
    ├── src/
    │   ├── main.tsx          # React entry point
    │   ├── App.tsx           # Main UI component
    │   ├── lib/              # API wrappers & type definitions
    │   │   ├── constants.ts  # Frontend constants (mirrors backend)
    │   │   ├── students.ts   # Student API wrapper
    │   │   ├── courses.ts    # Course API wrapper
    │   │   ├── enrollments.ts # Enrollment API wrapper
    │   │   ├── attendance.ts # Attendance API wrapper
    │   │   ├── invoices.ts   # Invoice API wrapper
    │   │   ├── payments.ts   # Payment API wrapper
    │   │   └── utils.ts      # Utility functions
    │   └── wailsjs/          # Auto-generated Wails bindings
    ├── package.json
    └── vite.config.ts
```

## Core Components

### Backend (Go)

#### Main Application Layer
- **main.go**: Wails app initialization
- **app.go**: Application controller, service coordination, lifecycle management
- **crud.go**: CRUD operations with validation helpers and DTO converters

#### Internal Services (`internal/app/`)
- **constants.go**: Shared constants across all services
- **attendance/service.go**: Monthly lesson attendance tracking
- **invoice/service.go**: Draft generation, invoice issuing, numbering, PDF creation
- **payment/service.go**: Payment creation, balance calculation, debtor tracking

#### Supporting Infrastructure
- **internal/infra/db.go**: SQLite database connection
- **internal/paths/paths.go**: User directory management (`~/LangSchool/`)
- **internal/pdf/invoice_pdf.go**: PDF generation with gofpdf

### Frontend (TypeScript/React)

#### API Layer (`frontend/src/lib/`)
Type-safe wrappers around Wails backend calls:
- **constants.ts**: Type-safe enums (CourseType, BillingMode, InvoiceStatus, PaymentMethod)
- **students.ts**: Student CRUD operations
- **courses.ts**: Course CRUD operations
- **enrollments.ts**: Enrollment CRUD operations
- **attendance.ts**: Attendance tracking operations
- **invoices.ts**: Invoice generation and management
- **payments.ts**: Payment creation and balance queries

#### UI Layer
- **App.tsx**: Main React component with tabs (Students, Courses, Enrollments, Attendance, Invoices, Payments)
- **wailsjs/**: Auto-generated Go ↔ TypeScript bindings

## Data Model

### Core Entities (ent schemas)
1. **Student**: id, fullName, phone, email, note, isActive
2. **Course**: id, name, type (group|individual), lessonPrice, subscriptionPrice
3. **Enrollment**: id, studentId, courseId, billingMode (subscription|per_lesson), discountPct, note
4. **AttendanceMonth**: studentId, courseId, year, month, lessonsCount, locked
5. **Invoice**: id, studentId, year, month, totalAmount, status (draft|issued|paid|canceled), number
6. **InvoiceLine**: invoiceId, enrollmentId, description, qty, unitPrice, amount
7. **Payment**: id, studentId, invoiceId, amount, method (cash|bank), paidAt, note
8. **Settings**: singleton configuration (invoicePrefix, nextSeq, etc.)
9. **PriceOverride**: time-bound custom pricing for enrollments

## Key Features

### 1. Student & Course Management
- Create/update/delete students and courses
- Student activation/deactivation
- Course types: group or individual lessons

### 2. Enrollment Management
- Link students to courses
- Billing modes: subscription (monthly fixed) or per-lesson
- Optional discount percentage per enrollment

### 3. Attendance Tracking
- Monthly attendance for per-lesson billing
- Quick edit counts per student/course
- "Add +1 to all" for bulk updates
- Lock months to prevent changes

### 4. Invoice Generation
- Auto-generate drafts from attendance + subscriptions
- Sequential numbering: `PREFIX-YYYYMM-SEQ`
- Issue invoices (draft → issued)
- PDF generation with customizable formatting
- Storage: `~/LangSchool/Invoices/YYYY/MM/NUMBER.pdf`

### 5. Payment Tracking
- Record payments (cash or bank transfer)
- Link payments to invoices
- Automatic invoice status updates (issued → paid)
- Student balance calculation
- Debtor list generation

## Constants & Types

### Shared Constants (Backend & Frontend)
- **CourseType**: `group`, `individual`
- **BillingMode**: `subscription`, `per_lesson`
- **InvoiceStatus**: `draft`, `issued`, `paid`, `canceled`
- **PaymentMethod**: `cash`, `bank`

These are defined in:
- Backend: `crud.go` and `internal/app/constants.go`
- Frontend: `frontend/src/lib/constants.ts`

## Data Storage

- **Database**: SQLite at `~/LangSchool/Data/app.sqlite`
- **Backups**: `~/LangSchool/Backups/`
- **Invoices**: `~/LangSchool/Invoices/YYYY/MM/`
- **Fonts**: `~/LangSchool/Fonts/` (DejaVu for Cyrillic PDF support)
- **Exports**: `~/LangSchool/Exports/`

## Development Workflow

1. **Database Schema Changes**: Modify `ent/schema/*.go` → run `go generate ./ent`
2. **Backend Changes**: Edit Go files → Wails hot-reloads
3. **Frontend Changes**: Edit TypeScript/React → Vite hot-reloads
4. **Add Bindings**: Export methods from `app.go` → Wails auto-generates TypeScript bindings

## Build & Run

```bash
# Development
wails dev

# Production build
wails build
```

## Recent Refactoring (This PR)

### Improvements Made:
1. **Backend**: Extracted validation helpers, DTO converters, constants in `crud.go`
2. **Internal Services**: Created shared `internal/app/constants.go`
3. **Frontend**: Created `frontend/src/lib/constants.ts` with type-safe enums
4. **Consistency**: All magic strings replaced with constants across all layers

### Benefits:
- Single source of truth for enum values
- Type safety in TypeScript
- Reduced code duplication
- Better maintainability
- Consistent error messages
